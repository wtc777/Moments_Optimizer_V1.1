<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.moments.optimizer.mapper.AnalysisHistoryMapper">

    <resultMap id="AnalysisHistoryResultMap" type="com.moments.optimizer.domain.AnalysisHistory">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="imagePath" column="image_path"/>
        <result property="inputText" column="input_text"/>
        <result property="outputText" column="output_text"/>
        <result property="durationMs" column="duration_ms"/>
        <result property="inputTokens" column="input_tokens"/>
        <result property="outputTokens" column="output_tokens"/>
        <result property="totalTokens" column="total_tokens"/>
        <result property="modelName" column="model_name"/>
        <result property="success" column="success"/>
        <result property="errorMessage" column="error_message"/>
    </resultMap>

    <select id="selectPageByUser" resultMap="AnalysisHistoryResultMap">
        SELECT id, user_id, created_at, image_path, input_text, output_text,
               duration_ms, input_tokens, output_tokens, total_tokens,
               model_name, success, error_message
        FROM analysis_history
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countByUser" parameterType="string" resultType="long">
        SELECT COUNT(1) FROM analysis_history WHERE user_id = #{userId}
    </select>

    <select id="selectById" parameterType="string" resultMap="AnalysisHistoryResultMap">
        SELECT id, user_id, created_at, image_path, input_text, output_text,
               duration_ms, input_tokens, output_tokens, total_tokens,
               model_name, success, error_message
        FROM analysis_history
        WHERE id = #{id}
    </select>

</mapper>
